---
title: 计算机体系
published: 2025-12-09
tags:
  - 学习笔记
  - 计算机体系结构
category: 课程
draft: false
---

## 第四章 向量处理机

向量：是一组有序的、具有相同类型和位数的元素组成。  
向量的优点：适合大量、重复、没有相互关联的（流水线处理）。  
向量流水处理机：设置向量数据表示和相应的向量指令。  
标量流水处理机：不具备向量数据表示和相应的向量指令。  
典型的向量处理机：Cray-1，每秒 1 亿次。  
向量处理机的应用领域：科学运算。

### 向量的处理方式

#### 横向处理方式
- 按行的方式计算
- 特点：只适合一般处理机
- 数据相关和功能切换：n  n

#### 纵向处理方式
- 按照列的方式计算
- 特点：适用于向量处理的并行处理
- 数据相关和功能切换：1  1

#### 纵横处理方式
- 把向量分成多组，组内纵向、组间横向
- 特点：对长度 N 无限制，但需按固定 n 个元素为一组
- 数据相关和功能切换：1  1

### 向量处理机的结构
结构：存储器-存储器型结构；寄存器-寄存器型结构。

#### 存储器-存储器结构
适用范围：纵向处理方式的向量处理机。  
结构特点：
1. 向量指令的源向量和目的向量都存放在存储器中，运算的中间结果需要送回到存储器中。
2. 运算部件的输入和输出都直接与存储器相连。  
运行条件：每拍从存储器中读取两个数据，并且向存储器写回一个结果。  
问题：对存储器的带宽和存储器与处理部件之间的通信带宽有很高的要求。  
解决方案：采用多体交叉并行存储器和缓冲器技术。

#### 寄存器-寄存器型结构
适用范围：分组处理的向量处理机。  
结构特点：
1. 能设置快速访问的向量寄存器，存放源向量、目标向量和中间结果。
2. 运算部件的输入和输出都直接与寄存器相连。

### CRAY-1 向量处理机

#### 基本结构
1. 功能部件  
   - 共 12 条单功能流水线  
   - 支持运算：整数加、逻辑运算、移位、浮点加、浮点乘、浮点迭代求倒数  

   | 单功能流水部件 | 流水线通过时间（一拍 12.5 ns） |
   |----------------|-------------------------------|
   | 整数加         | 3 拍                          |
   | 逻辑运算       | 2 拍                          |
   | 移位           | 4 拍                          |
   | 浮点加         | 6 拍                          |
   | 浮点乘         | 7 拍                          |
   | 浮点迭代求倒数 | 14 拍                         |

2. 向量寄存器组 V  
   - 512 个 64 位寄存器，分成 8 小组（每组 64 个寄存器）  
   - 每个小组可存放元素个数 ≤64 的向量，元素位宽 ≤64 位  
   - 每拍可从功能部件接收一个数据元素或返回一个结果元素  

3. 标量寄存器 S 和快速暂存器 T  
   - 标量寄存器 8 个  
   - T 暂存器为标量寄存器与存储器之间提供缓冲  

4. 向量屏蔽器 VM  
   - 用于向量的归并、压缩、还原、测试或单独运算

#### CRAY-1 的显著特点
1. 每个向量寄存器都有一条连接到六个流水线单功能部件的单独总线。
2. 每个向量功能部件都有把运算结果返回到向量寄存器的总线。
3. 只要不发生 `vi` 冲突和功能部件冲突，各功能部件可并行处理，提高效率。

#### vi 冲突和功能部件冲突
- **vi 冲突**：并行工作的向量指令使用了相同 `vi` 的源向量或结果向量。
- **功能部件冲突**：并行工作的向量指令使用了相同功能部件。

#### CRAY-1 的四种向量指令
1. 两个操作数都来自向量寄存器。
2. 一个操作数来自向量寄存器，一个来自标量寄存器。
3. 从主存向向量寄存器成组传送数据。
4. 从向量寄存器向主存成组传送数据。

### 提高向量处理机性能的方法
- 采用多个功能部件
- 循环开采技术
- 链接技术
- 多处理机技术

**设置多个功能部件**：各部件按各自流水线工作，形成并行流水线，互不干扰。  
**链接技术**：适用于上一步结果寄存器是下一步源寄存器且无其他冲突的情况。

---

## 第五章 指令级并行（ILP）

指令级并行：指令具有并行性，在没有结构冲突和数据冲突的情况下可并行执行；指两条及以上指令同时执行。  

开发 ILP 的方法：
- 基于软件的静态开发方法
- 基于硬件的动态开发方法

增加指令并行性的方法：
- 循环级并行：不同迭代间存在并行性，最简单
- 采用向量指令和向量数据表示

### 相关的三种类型
1. 数据相关
2. 名相关
3. 控制相关

### 流水线冲突类型
1. 结构冲突
2. 数据冲突
3. 控制冲突

### 相关与冲突
相关是指令间的依赖关系，是程序属性；相关造成的冲突及停顿属于流水线属性。  
解决思路：
- 保持相关：通过调度减小影响
- 消除相关：通过寄存器换名

### 程序顺序与正确性
- **程序顺序**：完全串行，前一条执行完才能执行后一条。
- **正确性**：包括数据流和异常行为。数据流指数据值从产生者到消费者指令的实际流动；无法消除的异常必须保持。

---

## 静态调度
**定义**：编译器在编译阶段对代码进行调度，减少相关与冲突。  
**特点**：在编译器完成，非运行时。  
**方法**：拉开指令距离减少停顿，如定向、延迟槽、停顿等。

---

## 动态调度
**定义**：在程序执行过程中，通过硬件对代码进行调度，减少数据相关造成的停顿。  
**优点**：可解决编译时无法确定的依赖，动态调度结果可被其他流水线利用。  
**缺点**：硬件复杂度明显提高。  
**方法**：硬件调整指令执行顺序。

### 动态调度基本思想
- 最大局限：指令按序流出、按序执行。
- 冲突检测：检测结构和数据冲突；无冲突即可流出。
- 解决方案：等待数据冲突解决；无结构冲突即可执行；操作数就绪立即执行。

### 乱序执行与乱序完成
- **流出**：无结构冲突即可流出。
- **读操作数**：等待数据冲突解决后读操作数。
- 可能出现 **写后读（WAR）** 和 **读后写（WAW）** 冲突。
- **乱序完成**：指令完成顺序与程序顺序不同。

### 动态调度流水线要求
- 多条指令可同时处于执行阶段
- 需多个功能部件或部件流水化，或二者兼有

### 典型动态调度算法
1. 记分牌算法
2. Tomasulo 算法

---

## 记分牌动态调度算法
**核心**：维护三张表——指令状态表、功能部件状态表、结果寄存器状态表。  
**目标**：无结构冲突时尽早执行无数据冲突指令，每周期执行一条。  
**前提**：具有多个功能部件。

### 指令执行四阶段
1. **流出**：功能部件空闲且目标寄存器无冲突 → 记录信息并修改状态表（解决写后写、结构冲突）。
2. **读操作数**：操作数可用 → 取寄存器值并开始执行（解决写后读，可能乱序）。
3. **执行**：取到操作数即执行，执行完通知记分牌。
4. **写结果**：检查写后读冲突；存在则等待，否则写回寄存器。

---

## Tomasulo 算法
**核心**：记录并检测指令相关，操作数就绪立即执行；通过寄存器换名消除 WAR、WAW 冲突。  
**部件**：
- 保留站（保留已流出等待执行的指令）
- 公共数据总线（CDB，广播结果）
- Load/Store 缓冲器（记录地址与数据）
- 浮点寄存器（FP）
- 指令队列（FIFO）
- 运算部件

### 指令执行三阶段
1. **流出**
2. **执行**
3. **写结果**

### 保留站字段
- `Busy`：保留站忙
- `Op`：操作类型
- `Vj, Vk`：源操作数值
- `Qj, Qk`：将产生源操作数的保留站号
- `A`：初始存立即数/偏移，地址计算后存有效地址

### 寄存器状态表
记录哪个保留站将写入哪个寄存器。

### Tomasulo 算法优点
1. 冲突检测逻辑分布式
2. 消除 WAR 和 WAW 冲突